---
import Layout from "../../layouts/Layout.astro";
import ButtonRow from "../../components/ButtonRow.astro";
import { getBlogPosts, getBlogSettings, urlFor } from "../../lib/sanity";
import { toHTML } from "@portabletext/to-html";

const posts = await getBlogPosts();
const settings = await getBlogSettings();

// Build sidebar image URL with crop/hotspot applied
const sidebarImageUrl = settings?.sidebarImage
  ? urlFor(settings.sidebarImage).url()
  : null;

// Helper function to truncate text to approximately 500 words
function truncateToWords(
  html: string,
  wordCount: number
): { truncated: string; isTruncated: boolean } {
  // Strip HTML tags for word counting
  const textOnly = html
    .replace(/<[^>]*>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
  const words = textOnly.split(" ");

  if (words.length <= wordCount) {
    return { truncated: html, isTruncated: false };
  }

  // Find approximate cut point in original HTML
  let wordsSeen = 0;
  let cutIndex = 0;
  const strippedForCounting = html.replace(/<[^>]*>/g, "\u0000");

  for (
    let i = 0;
    i < strippedForCounting.length && wordsSeen < wordCount;
    i++
  ) {
    if (strippedForCounting[i] === " " || strippedForCounting[i] === "\u0000") {
      if (
        i > 0 &&
        strippedForCounting[i - 1] !== " " &&
        strippedForCounting[i - 1] !== "\u0000"
      ) {
        wordsSeen++;
      }
    }
    cutIndex = i;
  }

  // Find a good break point (end of sentence or paragraph)
  let breakPoint = html.lastIndexOf(".", cutIndex + 100);
  if (breakPoint < cutIndex - 200) {
    breakPoint = cutIndex;
  }

  // Close any open tags
  let truncated = html.substring(0, breakPoint + 1);

  // Simple tag balancing - count opens and closes for common tags
  const tags = ["p", "div", "span", "strong", "em", "a", "ul", "ol", "li"];
  for (const tag of tags) {
    const openCount = (truncated.match(new RegExp(`<${tag}[^>]*>`, "gi")) || [])
      .length;
    const closeCount = (truncated.match(new RegExp(`</${tag}>`, "gi")) || [])
      .length;
    for (let i = 0; i < openCount - closeCount; i++) {
      truncated += `</${tag}>`;
    }
  }

  return { truncated, isTruncated: true };
}
---

<Layout title="Blog" description="Latest posts and updates">
  <!-- Banner Section -->
  <div
    class="blog-banner"
    style="background-image: url('/img/red-rock-2.jpeg');"
  >
    <div class="banner-overlay">
      <h1 class="banner-title">Journal</h1>
    </div>
  </div>

  <!-- Content Container -->
  <div class="blog-content-wrapper">
    <!-- Sidebar -->
    <aside class="blog-sidebar">
      <div class="sidebar-image-container">
        {
          sidebarImageUrl ? (
            <img src={sidebarImageUrl} alt="Profile" class="sidebar-image" />
          ) : (
            <div class="sidebar-image-placeholder" />
          )
        }
      </div>
      <div class="sidebar-text">
        {settings?.sidebarText || "Robert Marck"}
      </div>
      <hr class="sidebar-divider" />
      <p class="sidebar-subtitle">Engineer - Designer - Adventurer - Pilgrim</p>
      <p class="sidebar-bio">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
        commodo consequat.
      </p>
      <ButtonRow />
    </aside>

    <!-- Blog Posts -->
    <main class="blog-posts">
      {
        posts.length === 0 ? (
          <p class="no-posts">No blog posts yet. Check back soon!</p>
        ) : (
          posts.map((post: any, index: number) => {
            const bodyHtml = post.body ? toHTML(post.body) : "";
            const { truncated, isTruncated } = truncateToWords(bodyHtml, 500);

            return (
              <article class="blog-post" data-post-id={post._id}>
                {post.thumbnailUrl && (
                  <div class="post-featured-image">
                    <img src={post.thumbnailUrl} alt={post.title} />
                  </div>
                )}

                <h2 class="post-title">
                  <a href={`/blog/${post.slug.current}`}>{post.title}</a>
                </h2>

                {post.author && <p class="post-author">By {post.author}</p>}

                <hr class="post-divider" />

                <div class="post-body">
                  <div class="post-body-truncated" set:html={truncated} />
                  {isTruncated && (
                    <>
                      <div
                        class="post-body-full"
                        style="display: none;"
                        set:html={bodyHtml}
                      />
                      <button class="read-more-btn" data-expanded="false">
                        Read More
                      </button>
                    </>
                  )}
                </div>
                <div class="post-footer-bar">
                  <a href="#subscribe" class="subscribe-link">Subscribe</a>
                </div>
              </article>
            );
          })
        )
      }
    </main>
  </div>
</Layout>

<style>
  /* Banner Styles */
  .blog-banner {
    width: calc(100% - 2rem);
    height: 50vh;
    min-height: 300px;
    background-size: cover;
    background-position: center;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    margin: 1rem;
  }

  .banner-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      rgba(103, 47, 12, 0.429),
      rgba(35, 22, 8, 0.99)
    );
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
  }

  .banner-title {
    font-family: "Legan", var(--font-sans-serif);
    font-size: 8.625rem;
    font-variant: small-caps;
    text-transform: lowercase;
    font-weight: 300;
    color: rgba(255, 240, 219, 1);
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    margin: 0;
    transform: translateY(-0.5rem);
  }

  /* Content Wrapper */
  .blog-content-wrapper {
    width: 80%;
    max-width: 1400px;
    margin: 3rem auto;
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 3rem;
  }

  /* Sidebar Styles */
  .blog-sidebar {
    position: sticky;
    top: 2rem;
    align-self: start;
  }

  .sidebar-image-container {
    width: 80%;
    margin: 0 auto 1.5rem;
    overflow: hidden;
    border-radius: 8px;
  }

  .sidebar-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .sidebar-image-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #2a1a0f 0%, #1a0f08 100%);
  }

  .sidebar-text {
    font-size: 5rem;
    line-height: 1.6;
    color: #8b4513;
    text-align: center;
  }

  .sidebar-divider {
    width: 120px;
    border: none;
    border-top: 1px solid #888;
    margin: 2rem auto 0;
  }

  .sidebar-subtitle {
    font-size: 2.5rem;
    color: #888;
    text-align: center;
    margin: 2rem 0 0 0;
    font-style: italic;
  }

  .sidebar-bio {
    font-size: 2rem;
    line-height: 1.8;
    color: #333;
    margin: 2.5rem auto 5.5rem;
    text-align: center;
    width: 90%;
  }

  /* Blog Posts Styles */
  .blog-posts {
    display: flex;
    flex-direction: column;
    gap: 4rem;
  }

  .no-posts {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .blog-post {
    background: #fff;
    padding: 2rem 3rem 0 3rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
  }

  .post-footer-bar {
    background: rgb(218, 110, 42);
    margin: 3rem -3rem 0 -3rem;
    padding: 0.5rem 3rem;
    height: 48px;
    display: flex;
    align-items: center;
  }

  .subscribe-link {
    color: #fff;
    text-decoration: none;
    font-family: var(--font-sans-serif);
    font-size: 2.4rem;
    font-weight: 500;
    text-transform: lowercase;
    font-variant: small-caps;
    letter-spacing: 1px;
  }

  .subscribe-link:hover {
    text-decoration: underline;
  }

  .post-featured-image {
    width: 100%;
    max-height: 400px;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .post-featured-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-title {
    font-family: "Legan", var(--font-sans-serif);
    font-size: 5rem;
    font-variant: small-caps;
    text-transform: lowercase;
    font-weight: 300;
    margin: 0 0 0.5rem 0;
  }

  .post-title a {
    color: #8b4513;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .post-title a:hover {
    color: rgba(35, 22, 8);
  }

  .post-author {
    font-size: 2rem;
    color: #888;
    margin: 0 0 1rem 0;
    font-style: italic;
  }

  .post-divider {
    border: none;
    border-top: 1px solid #ddd;
    margin: 1.5rem 0;
  }

  .post-body {
    font-size: 2.2rem;
    line-height: 1.8;
    color: #333;
  }

  .post-body :global(p) {
    margin-bottom: 1rem;
  }

  .post-body :global(p:last-child) {
    margin-bottom: 0;
  }

  .post-body-full {
    animation: expandIn 0.5s ease-out;
  }

  @keyframes expandIn {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 5000px;
    }
  }

  .read-more-btn {
    display: inline-block;
    margin-top: 1.5rem;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: 2px solid #8b4513;
    color: #8b4513;
    font-family: "Legan", var(--font-sans-serif);
    font-size: 1rem;
    font-variant: small-caps;
    text-transform: lowercase;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 4px;
  }

  .read-more-btn:hover {
    background: #8b4513;
    color: #fff;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .blog-content-wrapper {
      width: 90%;
      grid-template-columns: 1fr;
    }

    .blog-sidebar {
      position: static;
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 1.5rem;
      align-items: start;
    }

    .sidebar-image-container {
      width: 120px;
      margin-bottom: 0;
    }

    .banner-title {
      font-size: clamp(4.8rem, 7.2vw + 1.65rem, 8.625rem);
    }
  }

  @media (max-width: 600px) {
    .blog-sidebar {
      grid-template-columns: 1fr;
    }

    .sidebar-image-container {
      width: 100%;
      max-width: 160px;
      margin: 0 auto 1rem;
    }

    .post-title {
      font-size: 4rem;
    }

    .banner-title {
      font-size: 4.8rem;
    }
  }

</style>

<script is:inline>
  // Read more/less functionality
  document.querySelectorAll(".read-more-btn").forEach((button) => {
    button.addEventListener("click", () => {
      const postBody = button.closest(".post-body");
      if (!postBody) return;

      const truncatedContent = postBody.querySelector(".post-body-truncated");
      const fullContent = postBody.querySelector(".post-body-full");
      const isExpanded = button.getAttribute("data-expanded") === "true";

      if (isExpanded) {
        // Collapse
        truncatedContent.style.display = "block";
        fullContent.style.display = "none";
        button.textContent = "Read More";
        button.setAttribute("data-expanded", "false");
      } else {
        // Expand
        truncatedContent.style.display = "none";
        fullContent.style.display = "block";
        button.textContent = "Read Less";
        button.setAttribute("data-expanded", "true");
      }
    });
  });
</script>
